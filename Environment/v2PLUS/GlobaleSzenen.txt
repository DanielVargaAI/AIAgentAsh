import type { BattleScene } from "#app/battle-scene";

export let globalScene: BattleScene;

export function initGlobalScene(scene: BattleScene): void {
  globalScene = scene;
  window.globalScene = globalScene;

  function serializePartyPokemon(p) {
    if (!p) return false;
    return {
      formIndex: p.formIndex ?? false,
      dex_nr: p.species?.speciesId ?? false,
      hp: p.hp ?? false,
      stats: p.stats ?? false,
      id: p.id ?? false,
      visible: p._visible ?? false,
      moveset: p.moveset
        ? p.moveset.map(m => ({
            id: m?.moveId ?? false,
          }))
        : [],
    };
  }

  function serializeEnemyPokemon(p) {
    if (!p) return false;
    return {
      formIndex: p.formIndex ?? false,
      dex_nr: p.species?.speciesId ?? false,
      hp: p.hp ?? false,
      stats: p.stats ?? false,
      id: p.id ?? false,
    };
  }

  function getPhaseData() {
    const phase = scene?.phaseManager?.currentPhase;
    return {
      phaseName: phase?.phaseName ?? false,
      moveId: phase?.moveId ?? false,
      partyMemberIndex: phase?.partyMemberIndex ?? false,
    };
  }

  function getMetaData() {
    const battle = scene?.currentBattle;
    return {
      waveIndex: battle?.waveIndex ?? false,
      isDoubleFight: battle?.double ?? false,
    };
  }

  globalThis.__GLOBAL_SCENE_DATA__ = () => {
    const battle = scene?.currentBattle;

    return {
      player: scene?.party?.length
        ? scene.party.map(serializePartyPokemon)
        : [],

      enemy: battle?.enemyParty?.length
        ? battle.enemyParty.map(serializeEnemyPokemon)
        : [],

      phase: getPhaseData(),

      metaData: getMetaData(),

      shopItems:
        scene?.phaseManager?.currentPhase?.typeOptions?.map(option => ({
          id: option?.type?.id ?? false,
          tier: option?.type?.tier ?? false,
        })) ?? [],
    };
  };
}
